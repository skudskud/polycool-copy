â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘         ğŸ—ï¸ PY-CLOB-SERVER V2 - RAILWAY DEPLOYMENT ARCHITECTURE              â•‘
â•‘                                                                                  â•‘
â•‘                        Audit Date: 2025-10-19                                   â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸš€ RAILWAY INFRASTRUCTURE (Deployment Container)                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Railway Container (NIXPACKS builder)                                     â”‚  â”‚
â”‚  â”‚ â€¢ Builder: NIXPACKS                                                      â”‚  â”‚
â”‚  â”‚ â€¢ Build Command: pip install -r requirements.txt                         â”‚  â”‚
â”‚  â”‚ â€¢ Start Command: uvicorn main:app --host 0.0.0.0 --port $PORT          â”‚  â”‚
â”‚  â”‚ â€¢ Memory: 512 MB (configurable)                                          â”‚  â”‚
â”‚  â”‚ â€¢ Restart Policy: ON_FAILURE (max 10 retries)                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                  â”‚
â”‚  âš ï¸ CRITICAL: Healthcheck Configuration                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Readiness Probe (âŒ PROBLÃˆME IDENTIFIÃ‰ #2)                              â”‚  â”‚
â”‚  â”‚ â”œâ”€ path: /health                                                         â”‚  â”‚
â”‚  â”‚ â”œâ”€ initialDelaySeconds: 60 â† TOO SHORT! Should be 180                   â”‚  â”‚
â”‚  â”‚ â”œâ”€ timeoutSeconds: 10                                                    â”‚  â”‚
â”‚  â”‚ â”œâ”€ periodSeconds: 10                                                     â”‚  â”‚
â”‚  â”‚ â””â”€ failureThreshold: 5                                                   â”‚  â”‚
â”‚  â”‚                                                                           â”‚  â”‚
â”‚  â”‚ âœ… Migrations take ~60-100 seconds                                       â”‚  â”‚
â”‚  â”‚ âœ… Readiness probe at 60s = premature timeout                           â”‚  â”‚
â”‚  â”‚ âœ… Result: Container killed â†’ redeploy infinite loop                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“Š FASTAPI APPLICATION STARTUP SEQUENCE (main.py:103-416)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                  â”‚
â”‚  1ï¸âƒ£  /health endpoint ready IMMEDIATELY                                         â”‚
â”‚      â””â”€ Returns: {"status": "healthy", "timestamp": ...}                        â”‚
â”‚                                                                                  â”‚
â”‚  2ï¸âƒ£  DATABASE MIGRATIONS (SYNCHRONOUS - BLOCKING)                               â”‚
â”‚      â”œâ”€ run_withdrawal_migration()          ~5-10 seconds                       â”‚
â”‚      â”‚  â””â”€ Creates withdrawals table                                            â”‚
â”‚      â”‚                                                                           â”‚
â”‚      â”œâ”€ run_smart_wallet_migration()        ~10-20 seconds                      â”‚
â”‚      â”‚  â””â”€ Creates smart_wallets tables                                         â”‚
â”‚      â”‚  â””â”€ âŒ PROBLEM #4: Uses relative path (can fail)                        â”‚
â”‚      â”‚                                                                           â”‚
â”‚      â””â”€ run_fix_market_id_migration()       ~5-10 seconds                       â”‚
â”‚         â””â”€ Fixes market_id column length                                        â”‚
â”‚         â””â”€ âŒ PROBLEM #4: Uses relative path (can fail)                        â”‚
â”‚                                                                                  â”‚
â”‚  3ï¸âƒ£  PostgreSQL CONNECTION CHECK                                                â”‚
â”‚      â””â”€ count_by_status() query                                                 â”‚
â”‚                                                                                  â”‚
â”‚  4ï¸âƒ£  SCHEDULER JOBS (APScheduler - ASYNC)                                       â”‚
â”‚      â”œâ”€ Market Updater HIGH PRIORITY    (every 5 min)                           â”‚
â”‚      â”œâ”€ Market Updater LOW PRIORITY     (every 1 hour)                          â”‚
â”‚      â”œâ”€ Hot Price Updater              (every 60 seconds) - Redis cache         â”‚
â”‚      â””â”€ New Market Detector             (every 5 minutes) - Events API          â”‚
â”‚                                                                                  â”‚
â”‚  5ï¸âƒ£  AUTO-APPROVAL SERVICE (if ENABLED)                                         â”‚
â”‚      â””â”€ monitor_unfunded_wallets() (every 30 seconds)                           â”‚
â”‚                                                                                  â”‚
â”‚  6ï¸âƒ£  SMART WALLET MONITOR                                                       â”‚
â”‚      â”œâ”€ Initialize SmartWalletMonitorService                                    â”‚
â”‚      â”œâ”€ Load curated wallets from CSV                                           â”‚
â”‚      â””â”€ Initial backfill (last 2 days) - ASYNC in background                    â”‚
â”‚         â””â”€ âš ï¸ PROBLEM #7: Can take 10-15 minutes on first deploy!              â”‚
â”‚                                                                                  â”‚
â”‚  7ï¸âƒ£  TWITTER BOT (if TWITTER_ENABLED=true)                                     â”‚
â”‚      â””â”€ TwitterBotService initialized                                           â”‚
â”‚      â””â”€ Scheduled: process_pending_trades (every 2 minutes)                     â”‚
â”‚                                                                                  â”‚
â”‚  8ï¸âƒ£  TELEGRAM BOT INITIALIZATION & POLLING                                      â”‚
â”‚      â”œâ”€ Initialize TelegramTradingBot                                           â”‚
â”‚      â”œâ”€ Setup bot commands (/start, /buy, /sell, etc.)                         â”‚
â”‚      â”œâ”€ Start TP/SL Price Monitor                                               â”‚
â”‚      â””â”€ Start polling (drop_pending_updates=True)                               â”‚
â”‚                                                                                  â”‚
â”‚  âœ…  COMPLETE: "24/7 Server startup complete!"                                 â”‚
â”‚                                                                                  â”‚
â”‚  â±ï¸  Total startup time: ~60-100 seconds (normal)                              â”‚
â”‚  â±ï¸  First time (with backfill): 15-20 minutes                                  â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ—„ï¸  DATABASE LAYER (PostgreSQL on Railway)                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                  â”‚
â”‚  CONNECTION CONFIGURATION                                                       â”‚
â”‚  â”œâ”€ DATABASE_URL: postgresql://postgres:***@mainline.proxy.rlwy.net:13288/... â”‚
â”‚  â”œâ”€ Pool Size: 10 connections                                                   â”‚
â”‚  â”œâ”€ Max Overflow: 20 connections                                                â”‚
â”‚  â””â”€ Pool Pre-Ping: True (verify before use)                                     â”‚
â”‚                                                                                  â”‚
â”‚  ğŸ—‚ï¸  DATABASE MODELS (âŒ PROBLEM #5: TWO SOURCES OF TRUTH)                      â”‚
â”‚                                                                                  â”‚
â”‚  âŒ database.py (root level)                                                     â”‚
â”‚  â”œâ”€ User (users table) - with AES-256-GCM encrypted private keys               â”‚
â”‚  â”œâ”€ TPSLOrder (tpsl_orders table)                                               â”‚
â”‚  â”œâ”€ Transaction (transactions table)                                            â”‚
â”‚  â”œâ”€ Withdrawal (withdrawals table)                                              â”‚
â”‚  â””â”€ Engine #1 (separate SQLAlchemy engine)                                      â”‚
â”‚                                                                                  â”‚
â”‚  âœ… core/persistence/models.py (better structure)                               â”‚
â”‚  â”œâ”€ Market (markets table) - 40+ columns for Polymarket data                   â”‚
â”‚  â”œâ”€ db_config.py defines Engine #2                                              â”‚
â”‚  â””â”€ Engine #2 (separate SQLAlchemy engine) â† DUPLICATE!                         â”‚
â”‚                                                                                  â”‚
â”‚  âš ï¸ ISSUE: Two separate SQLAlchemy engines                                      â”‚
â”‚     â”œâ”€ Duplicate connection pooling                                             â”‚
â”‚     â”œâ”€ Potential transaction isolation issues                                   â”‚
â”‚     â”œâ”€ Hard to maintain consistency                                             â”‚
â”‚     â””â”€ âŒ main.py:156 tries to import Market from wrong module!                â”‚
â”‚                                                                                  â”‚
â”‚  ğŸ“Š TABLES CREATED (19+ migrations)                                             â”‚
â”‚  â”œâ”€ markets (40+ columns)                                                       â”‚
â”‚  â”œâ”€ users                                                                        â”‚
â”‚  â”œâ”€ transactions                                                                â”‚
â”‚  â”œâ”€ tpsl_orders                                                                 â”‚
â”‚  â”œâ”€ withdrawals                                                                 â”‚
â”‚  â”œâ”€ smart_wallets                                                               â”‚
â”‚  â”œâ”€ smart_wallet_trades                                                         â”‚
â”‚  â”œâ”€ fees, referrals, referral_commissions                                       â”‚
â”‚  â””â”€ ... + other tables                                                          â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ”§ CONFIGURATION LAYER (âŒ PROBLEM #6: HYBRID IMPORTS)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                  â”‚
â”‚  âŒ Hybrid Import Pattern (Split across 2 files)                                â”‚
â”‚                                                                                  â”‚
â”‚  config.py (root level)                      config/config.py (subdir)         â”‚
â”‚  â”œâ”€ GAMMA_API_URL                            â”œâ”€ AUTO_APPROVAL_ENABLED          â”‚
â”‚  â”œâ”€ CLOB_API_URL                             â”œâ”€ WALLET_CHECK_INTERVAL_SECONDS  â”‚
â”‚  â”œâ”€ BOT_TOKEN                                â”œâ”€ REDIS_URL                       â”‚
â”‚  â””â”€ MARKET_UPDATE_INTERVAL                   â”œâ”€ PRICE_UPDATE_INTERVAL          â”‚
â”‚                                              â””â”€ ... + 30+ other vars           â”‚
â”‚                                                                                  â”‚
â”‚  main.py:32-33 imports BOTH:                                                    â”‚
â”‚  from config import GAMMA_API_URL, ...                                          â”‚
â”‚  from config.config import AUTO_APPROVAL_ENABLED, ...                           â”‚
â”‚                                                                                  â”‚
â”‚  âš ï¸ ISSUES:                                                                     â”‚
â”‚  â”œâ”€ Confusing for developers                                                    â”‚
â”‚  â”œâ”€ Risk of missed imports                                                      â”‚
â”‚  â”œâ”€ Environment variable duplication                                            â”‚
â”‚  â””â”€ .env.example missing = configuration undocumented                          â”‚
â”‚                                                                                  â”‚
â”‚  âœ… FIX: Consolidate into single config.py                                     â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ¯ SERVICES LAYER (18 services - core/services/)                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                  â”‚
â”‚  ğŸ“Š MARKET SERVICES                                                              â”‚
â”‚  â”œâ”€ market_updater_service.py       - Fetches from Gamma API (5min + 1hr)      â”‚
â”‚  â”œâ”€ market_fetcher_service.py       - Raw API fetch                            â”‚
â”‚  â”œâ”€ market_categorizer_service.py   - AI categorization (OpenAI)               â”‚
â”‚  â”œâ”€ market_grouping_service.py      - Groups by event                          â”‚
â”‚  â””â”€ market_group_cache.py           - Redis cache for groups                   â”‚
â”‚                                                                                  â”‚
â”‚  ğŸ’° PRICE & TRADING SERVICES                                                    â”‚
â”‚  â”œâ”€ redis_price_cache.py            - Hot prices (60 sec refresh)              â”‚
â”‚  â”œâ”€ price_updater_service.py        - Updates price cache                      â”‚
â”‚  â””â”€ balance_checker.py              - User balance checking                    â”‚
â”‚                                                                                  â”‚
â”‚  ğŸ‘¤ USER & SECURITY SERVICES                                                    â”‚
â”‚  â”œâ”€ user_service.py                 - User management                          â”‚
â”‚  â”œâ”€ encryption_service.py           - AES-256-GCM key encryption              â”‚
â”‚  â”œâ”€ api_key_manager.py              - API key generation                       â”‚
â”‚  â”œâ”€ auto_approval_service.py        - Wallet auto-funding                      â”‚
â”‚  â””â”€ approval_manager.py             - Contract approvals (USDC, POL)          â”‚
â”‚                                                                                  â”‚
â”‚  ğŸ¤– BOT SERVICES                                                                â”‚
â”‚  â”œâ”€ smart_wallet_monitor_service.py - Trades monitoring (every 10 min)        â”‚
â”‚  â”œâ”€ twitter_bot_service.py          - Tweets smart wallet trades              â”‚
â”‚  â””â”€ notification_service.py         - User notifications                       â”‚
â”‚                                                                                  â”‚
â”‚  ğŸ› ï¸ UTILITY SERVICES                                                             â”‚
â”‚  â”œâ”€ user_states.py                  - FSM for user dialogs                     â”‚
â”‚  â””â”€ (others)                                                                    â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ¤– TELEGRAM BOT LAYER (43 files - telegram_bot/)                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                  â”‚
â”‚  HANDLERS (User interactions)                                                   â”‚
â”‚  â”œâ”€ /start, /help              - Onboarding                                     â”‚
â”‚  â”œâ”€ /buy, /sell                - Trading                                        â”‚
â”‚  â”œâ”€ /balance, /positions        - Account info                                  â”‚
â”‚  â”œâ”€ /pnl                        - P&L calculation                               â”‚
â”‚  â”œâ”€ /tpsl                       - Take Profit / Stop Loss                       â”‚
â”‚  â”œâ”€ /search {query}             - Market search                                â”‚
â”‚  â”œâ”€ /settings                   - User preferences                             â”‚
â”‚  â””â”€ ... + inline buttons        - Quick actions                                â”‚
â”‚                                                                                  â”‚
â”‚  CORE FEATURES                                                                  â”‚
â”‚  â”œâ”€ Wallet generation (auto-generated per user)                                â”‚
â”‚  â”œâ”€ Order placement (USDC on Polymarket)                                       â”‚
â”‚  â”œâ”€ Position tracking                                                          â”‚
â”‚  â”œâ”€ TP/SL monitoring (every 10 seconds)                                        â”‚
â”‚  â”œâ”€ Price alerts                                                               â”‚
â”‚  â””â”€ Referral system                                                            â”‚
â”‚                                                                                  â”‚
â”‚  PRICE MONITOR (TPSLPrice Monitor)                                             â”‚
â”‚  â”œâ”€ Checks active TP/SL orders (every 10 seconds)                             â”‚
â”‚  â”œâ”€ Executes triggered orders                                                  â”‚
â”‚  â””â”€ Sends notifications to users                                               â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“¦ DEPENDENCIES (52 total - âŒ PROBLEM #3: DUPLICATES FOUND)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                  â”‚
â”‚  DUPLICATES FOUND:                                                              â”‚
â”‚  â”œâ”€ sqlalchemy>=2.0.0         listed TWICE (line 7 + 38)                        â”‚
â”‚  â””â”€ psycopg2-binary>=2.9.0    listed TWICE (line 8 + 37)                        â”‚
â”‚                                                                                  â”‚
â”‚  CORE DEPENDENCIES                                                              â”‚
â”‚  â”œâ”€ fastapi>=0.104.0           - Web framework                                  â”‚
â”‚  â”œâ”€ uvicorn[standard]>=0.24.0  - ASGI server                                   â”‚
â”‚  â”œâ”€ python-telegram-bot>=20.0  - Bot framework                                  â”‚
â”‚  â””â”€ apscheduler>=3.10.0        - Job scheduler                                  â”‚
â”‚                                                                                  â”‚
â”‚  DATABASE                                                                       â”‚
â”‚  â”œâ”€ sqlalchemy>=2.0.0           - ORM                                           â”‚
â”‚  â”œâ”€ psycopg2-binary>=2.9.0      - PostgreSQL driver                             â”‚
â”‚  â””â”€ alembic>=1.12.0             - Migrations                                    â”‚
â”‚                                                                                  â”‚
â”‚  BLOCKCHAIN (HEAVY)                                                             â”‚
â”‚  â”œâ”€ web3>=6.0.0                 - Ethereum/Polygon                             â”‚
â”‚  â”œâ”€ eth-account>=0.8.0          - Account management                           â”‚
â”‚  â”œâ”€ py-clob-client>=0.1.0       - Polymarket API wrapper                       â”‚
â”‚  â”œâ”€ solana>=0.30.0              - Solana blockchain                            â”‚
â”‚  â”œâ”€ solders>=0.18.0             - Solana types                                  â”‚
â”‚  â””â”€ ... + 10+ more              - Bridge, crypto, keys                          â”‚
â”‚                                                                                  â”‚
â”‚  CACHING & PERFORMANCE                                                          â”‚
â”‚  â”œâ”€ redis>=5.0.0                - Price cache                                   â”‚
â”‚  â””â”€ cryptography>=3.4.0         - AES-256-GCM encryption                       â”‚
â”‚                                                                                  â”‚
â”‚  AI/ML                                                                          â”‚
â”‚  â””â”€ openai>=1.0.0               - Market categorization                         â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âš¡ DATA FLOW: Buy Order Example                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                  â”‚
â”‚  User /buy YES $50                                                              â”‚
â”‚    â†“                                                                             â”‚
â”‚  [Telegram Handler] buy_handler()                                               â”‚
â”‚    â†“                                                                             â”‚
â”‚  [Trading Logic]                                                                â”‚
â”‚  â”œâ”€ Get market via API (gamma-api.polymarket.com)                              â”‚
â”‚  â”œâ”€ Get current prices (Redis cache)                                           â”‚
â”‚  â”œâ”€ Get user wallet from database                                              â”‚
â”‚  â”œâ”€ Create OrderArgs (Polymarket format)                                        â”‚
â”‚  â””â”€ Sign with user's private key (AES-256 decrypted)                           â”‚
â”‚    â†“                                                                             â”‚
â”‚  [Submit Order]                                                                 â”‚
â”‚  â”œâ”€ POST to Polymarket CLOB API                                                â”‚
â”‚  â”œâ”€ Wait for confirmation                                                      â”‚
â”‚  â””â”€ Store transaction in database                                              â”‚
â”‚    â†“                                                                             â”‚
â”‚  [TP/SL Monitor]                                                                â”‚
â”‚  â”œâ”€ Record entry price                                                         â”‚
â”‚  â”œâ”€ Watch prices every 10 seconds                                              â”‚
â”‚  â”œâ”€ If price hits TP â†’ SELL automatically                                      â”‚
â”‚  â””â”€ If price hits SL â†’ SELL automatically                                      â”‚
â”‚    â†“                                                                             â”‚
â”‚  [Notifications]                                                                â”‚
â”‚  â”œâ”€ Send to Telegram chat                                                      â”‚
â”‚  â””â”€ If enabled: Tweet to Twitter                                               â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


ğŸ“‹ SUMMARY OF ISSUES FOUND

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ”´ CRITICAL ISSUES (3)                                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  #2  Railway readiness probe timeout too short                  â† FIX ASAP      â”‚
â”‚  #5  Database models scattered (2 sources of truth)             â† FIX ASAP      â”‚
â”‚  #1  Migration runner imports failing                           â† FIX ASAP      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸŸ¡ HIGH PRIORITY ISSUES (7)                                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  #3  Dependencies duplicated in requirements.txt                 â† Today        â”‚
â”‚  #4  Migration file paths inconsistent                          â† Today        â”‚
â”‚  #6  Config split across 2 files (hybrid imports)               â† Today        â”‚
â”‚  #7  Migrations run synchronously (block healthcheck)           â† This week    â”‚
â”‚  #8  Wrong import for Market model                              â† Today        â”‚
â”‚  #9  Multiple entry points (confusing but harmless)             â† Low priority â”‚
â”‚  #10 Environment variables not documented (.env.example missing)â”‚ â† This week   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                              Audit Complete! âœ…
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
